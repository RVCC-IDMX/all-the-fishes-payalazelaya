<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>All the Fishes</title>
  </head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
  <body>
    <script>
      // The app
      const app = new PIXI.Application({
        width: 740,
        height: 600,
        backgroundColor: 0x9dc6ff,
      });

      //Give us the view
      document.body.appendChild(app.view);

      // Fishes for Aquarium
      const my_sprite = PIXI.Sprite.from('img/fish.png');
      const my_sprite2 = PIXI.Sprite.from('img/fish.png');
      const my_sprite3 = PIXI.Sprite.from('img/angel_fish.png');
      const my_sprite4 = PIXI.Sprite.from('img/blue_fish.png');
      const my_sprite5 = PIXI.Sprite.from('img/tropical_fish.png');
      const my_sprite6 = PIXI.Sprite.from('img/colorful_fish.png');

      //Bubbles for Aquarium
      const bubble = PIXI.Sprite.from('img/bubble.png');
      const bubble2 = PIXI.Sprite.from('img/bubble.png');
      const bubble3 = PIXI.Sprite.from('img/bubble.png');
      const bubble4 = PIXI.Sprite.from('img/bubble.png');

      const bubbles = [bubble, bubble2, bubble3, bubble4];

      bubbles.forEach((bubble) => {
        bubble.scale.set(0.10);
        bubble.anchor.set(1);
        bubble.position.set(Math.random() * 700, 550);
      });

      //Background for Aquarium
      const tank = PIXI.Sprite.from('img/fish_tank.png');

      //Measurements for background
      tank.scale.set(1.55, 1.55);
      tank.x = 0;
      tank.y = 0;

      //Scale the fishes
      my_sprite.scale.set(1, 1);
      my_sprite2.scale.set(-0.5, 0.5);
      my_sprite3.scale.set(0.3, 0.3);
      my_sprite4.scale.set(-0.1, 0.1);
      my_sprite5.scale.set(0.2, 0.2);
      my_sprite6.scale.set(0.3, 0.3);

      // Position the fishes
      my_sprite.position.set(100, 100);
      my_sprite2.position.set(500,350);
      my_sprite3.position.set(300,550);
      my_sprite4.position.set(700,200);
      my_sprite5.position.set(500,50);
      my_sprite6.position.set(30,60);

      // Flip the fishes
      my_sprite2.anchor.set(1);
      my_sprite3.anchor.set(1);

      // Tint the fishes
      my_sprite2.tint = 0x8b4000;
      my_sprite3.tint = 0x0e86d4;
      my_sprite4.tint = 0xffff00;
      my_sprite5.tint = 0xffc0cb;
      my_sprite6.tint = 0xff0000;

       //Draggable event listeners
      // let dragging = false;
      // offsetX = 0;
      // offsetY = 0;

      // my_sprite6.on("pointerdown", (e) => {
      //   dragging = true;
      //   offsetX = my_sprite6.x - e.data.global.x;
      //   offsetY = my_sprite6.y - e.data.global.y;
      // })

      // my_sprite6.on("pointermove", (e) => {
      //   if (dragging) {
      //     my_sprite6.x = e.data.global.x + offsetX;
      //     my_sprite6.y = e.data.global.y + offsetY;
      //   }
      // })

      // my_sprite6.on("pointerup", (e) => {
      //   dragging = false; 
      // })

      //Create fish container
      const my_container = new PIXI.Container();

      //Add fish and bubbles to stage
      app.stage.addChild(tank);

      app.stage.addChild(my_sprite);
      app.stage.addChild(my_sprite2);
      app.stage.addChild(my_sprite3);
      app.stage.addChild(my_sprite4);
      app.stage.addChild(my_sprite5);
      app.stage.addChild(my_sprite6);

      app.stage.addChild(bubble);
      app.stage.addChild(bubble2);
      app.stage.addChild(bubble3);
      app.stage.addChild(bubble4);

      //  Set up fish button
      //  function makeButton() {
         //Container for button
      //    let ourButton = new PIXI.Container();
      //    ourButton.interactive = true;
       

      //  Create button body
      //  let buttonBody = new PIXI.Graphics();
      //  buttonBody.beginFill(0xaafeff);
      //  buttonBody.drawRoundedRect(0,0,220,70);
      //  ourButton.addChild(buttonBody);
       
      //  let buttonText = new PIXI.Text('Change the color of the biggest fish');
      //  buttonText.scale.set(.5);
      //  buttonText.anchor.set(.5);
      //  buttonText.position.set(buttonBody.width / 2, buttonBody.height / 2);
      //  buttonText.style.fontFamily = 'Calibri';
      //  buttonText.style.fill = 0x0000FF;
      //  buttonText.style.fontSize = '28px';
      //  ourButton.addChild(buttonText);

      //  ourButton.label = buttonText;
      //  ourButton.body = buttonBody;

      //  Click Listener
      //  ourButton.on("pointertap", (e) => {
      //   my_sprite3.tint = 0xFFFFFF * Math.random();
      //  });

      //  Hover Listener 
      //  ourButton.on("pointerover", (e) => {
      //   buttonBody.alpha = 0.9;
      //  });
      //  ourButton.on("pointerout", (e) => {
      //   buttonBody.alpha = 1;
      //  })

      //  return ourButton;
      // }
      
      // let button = makeButton();
      // button.position.set(50, 10);
      // app.stage.addChild(button);

      //  Create slider 
      // function makeSlider() {
      //    create slider container
      //   let ourButton = new PIXI.Container();
      //   ourButton.interactive = true;

      //    Value from 0.0 to 1.0
      //   ourButton.value = 0;

      //    The track
      //   let theTrack = new PIXI.Graphics();
      //   theTrack.beginFill(0x1b3f94);
      //   theTrack.drawRect(0, -10, 200, 20);
      //   ourButton.addChild(theTrack);

      //    The slide
      //   let theSlide = PIXI.Sprite.from("img/silly_fish.png");
      //   theSlide.interactive = true;
      //   theSlide.anchor.set(.5);
      //   theSlide.scale.set(.3);
      //   theSlide.position.set(10, -3);
      //   ourButton.addChild(theSlide)

      //   theSlide.dragging = false;

      //   theSlide.on("pointerdown", (e) => {
      //     theSlide.dragging = true;
      //   })

      //   theSlide.on("pointermove", (e) => {
      //     if (theSlide.dragging) {
      //       let newX = e.data.global.x - ourButton.getGlobalPosition().x;
      //       let newY = e.data.global.y - ourButton.getGlobalPosition().y;

      //       if (newX > theTrack.width) newX = theTrack.width;
      //       if (newX < 0 ) newX = 0;

      //       ourButton.value = newX/theTrack.width;
      //       theSlide.x = newX;
      //       my_sprite5.rotation = (ourButton.value * 50);
      //     }
      //   });
        
      //   theSlide.on("pointerup", (e) => {
      //     theSlide.dragging = false;
      //   })

      //   theSlide.on("pointerupoutside", (e) => {
      //     theSlide.dragging = false;
      //   })

      //   return ourButton;
      // }

      // let slider = makeSlider();
      // slider.position.set (80,150);
      // app.stage.addChild(slider);

//The animator
let Animate = {};

//Easings

//Linear, in goes x, out comes x
Animate.linear = (x) => x;

//Quadratic
Animate.easeIn  = (x) => x * x;
Animate.easeOut = (x) => 1 - (1 - x) * (1 - x);
Animate.easeInOut = (x) => x < 0.5 ? 2 * x * x : 1 - Math.pow(-2 * x + 2, 2) / 2;

Animate.wobbleto = function(obj, end) {
    return new Promise((resolve, reject) => {
        let start = {
            x: obj.x,
            y: obj.y,
        }

        if (end.duration == undefined) end.duration = 0;
        if (end.easing == undefined) end.easing = Animate.linear; 

        var startTime = Date.now();

        function loop() {

            let ticker = Date.now() - startTime;
            let delta = ticker/end.duration;
            let ease = end.easing(delta);

            let wobble1 = Math.sin(ticker/200) * 20;

            if (delta >= 1 || end.duration === 0) {
                obj.x = end.x;
                obj.y = end.y;

                resolve();
                return;
            }


            let lerp = (a, b, n) => {
                return (1 - n) * a + n * b;
            }


            obj.x = lerp(start.x,end.x,ease);
            obj.y = lerp(start.y,end.y,ease);
            obj.y += wobble1;
            obj.animationID = requestAnimationFrame(loop);

        }
        cancelAnimationFrame(obj.animationID);
        loop();

    });
}

//Animate to
Animate.to = function(obj,end) {

    //Make it a promise:
    return new Promise( (resolve,reject) => {

        //Set up initial state parameters
        //We need to know where we started for this to work
        //Just x and y to start
        var start = {
            x : obj.x,
            y : obj.y,
            scale: {
                x : obj.scale.x,
                y : obj.scale.y
            },
            angle : obj.angle,
            tint : obj.tint,
            alpha : obj.alpha
        }

        //Set some defaults
        if (end.duration == undefined) end.duration = 0;
        if (end.easing == undefined) end.easing = Animate.linear;

        //We need to know when we've started animating
        var startTime = Date.now();

        //This will be our personal animation loop
        function loop() {

            //Calculate our delta
            let ticker = Date.now() - startTime;
            let delta = ticker/end.duration;
            let ease = end.easing(delta);

            //Fire our custom loop function, if there is one
            if (end.loop != undefined) end.loop(obj,end,{ticker,delta,ease});

            //If we're done, just snap to the end!
            if (delta >= 1) {
                if (end.x != undefined) obj.x = end.x;
                if (end.y != undefined)obj.y = end.y;
                if (end.scale != undefined) obj.scale.set(end.scale.x,end.scale.y);
                if (end.angle != undefined) obj.angle = end.angle;
                if (end.tint != undefined) obj.tint = end.tint;
                if (end.alpha != undefined) obj.alpha = end.alpha;
                console.log("Done!");
                
                resolve();
                return;
            }

            //Interpolation function
            let lerp = (a, b, n) => {
                return (1 - n) * a + n * b;
            }

            //Interpolate (lerp) our x coordinate
            if (end.x != undefined)
                obj.x = lerp(start.x,end.x,ease);

            //Lerp our y coordinate
            if (end.y != undefined)
                obj.y = lerp(start.y,end.y,ease);

            //Lerp our scale
            if (end.scale != undefined)
                obj.scale.set(lerp(start.scale.x,end.scale.x,ease), 
                            lerp(start.scale.y,end.scale.y,ease)
                );

            //Lerp our rotation -- we'll need to clean this up, but later
            if (end.angle != undefined)
                obj.angle = lerp(start.angle, end.angle, ease);

            //Lerp our tint -- we'll also need to clean this up for each channel, but later
            if (end.tint != undefined)
                obj.tint = lerp(start.tint,end.tint,ease);

            //Lerp our alpha
            if (end.alpha != undefined)
                obj.alpha = lerp(start.alpha,end.alpha,ease);

            //Start the loop going!
            obj.animationID = requestAnimationFrame(loop);

        }

        //Clear the animation ID so there aren't competing loops
        cancelAnimationFrame(obj.animationID);

        //Begin the loop!
        loop();

    //End Promise
    });

};

//Stop an object animating
Animate.stop = function(obj) {
        
    cancelAnimationFrame(obj.animationID);

};

//Personal animation loop
Animate.loop = function(obj,loopFunc) {

    //No state parameters

    //We need to know when we've started animating
    var startTime = Date.now();

    //This will be our personal animation loop
    function loop() {

        //Calculate our parameters
        var params = {
            ticker : Date.now() - startTime
        };
        
        //In here it's just our own code
        loopFunc(params);

        //Start the loop going!
        obj.animationID = requestAnimationFrame(loop);

    }

    //Clear the animation ID so there aren't competing loops
    cancelAnimationFrame(obj.animationID);

    //Begin the loop!
    loop();

};

      let moveMySprite = async () => {
        await Animate.to(my_sprite, {x: 150, y: 140, duration: 1500, easing: Animate.easeOut});
        await Animate.to(my_sprite, {x: 620, y: 450, duration: 1500, easing: Animate.easeIn});
        moveMySprite();
      }

      let moveMySprite3 = async () => {
        await Animate.wobbleto(my_sprite3, {x: 200, y: 350, duration: 2500, easing: Animate.linear});
        await Animate.to(my_sprite3, {
          scale : {
            x:-.2,
            y:.2
          }, 
          duration: 500, 
          easing: Animate.easeIn
        });
        await Animate.wobbleto(my_sprite3, {x: 500, y: 480, duration: 2500, easing: Animate.linear});
        await Animate.to(my_sprite3, {
          scale: {
            x: .2,
            y: .2
          }, 
          duration: 500, 
          easing: Animate.easeIn
        });
        moveMySprite3();
      }

      let moveMySprite5 = async () => {
        await Animate.to(my_sprite5, {
          scale: {
            x: .2, 
            y: .2,
          }, 
          duration: 700, 
          easing: Animate.easeIn
        });
        await Animate.to(my_sprite5, {
          scale: {
            x: .4, 
            y: .4, 
          },
            duration: 400,
            easing: Animate.easeOut});
        moveMySprite5();
      }

      let partyFish = async () => {
        await Animate.to(my_sprite6, {tint: 0xADD8E6, duration: 3000});
        await Animate.to(my_sprite6, {angle: 360, duration: 2500});
        await Animate.to(my_sprite6, {alpha: 1, duration: 800});
        await Animate.to(my_sprite6, {tint: 0xFFCCCB, duration: 2000});
        await Animate.to(my_sprite6, {angle: -360, duration: 2500});
        await Animate.to(my_sprite6, {alpha: 1, duration: 800});
        partyFish();
      }

      let moveBubbles = async () => {
        bubbles.forEach(async (bubble) => {
          await Animate.to(bubble, {x: -100, y: bubble.y, duration: Math.random() * 600 + 200});
          bubble.position.set(Math.random() * 740, 500);
          bubble.scale.set(Math.random() / 4);
          moveBubbles();
        })
      }
    
      moveMySprite();
      moveMySprite3();
      moveMySprite5();
      partyFish();
      moveBubbles();
    </script>
  </body>
</html>
